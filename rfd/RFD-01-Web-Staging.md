# Web Deployment
## Author: Cole Styron
## Status: draft

## Purpose

Creation of a new website deploy model and staging environment after the probable retirement of the `gravitational/web` repository.

## Antecedents

The current iteration of "staging" is a kubernetes-based environment.

Problems with the current version include: 
- it is relatively opaque in its operation for users unfamiliar with the relevant technologies (namely kubernetes), which is most of the marketing and UX personnel
- it is difficult to troubleshoot
- it requires a manual deploy from the command line (a problem for non-technical users)
- it is singular; a deploy to staging replaces the previous state, so users must queue and communicate synchronously
- it is presently not functional for users on an M1 Mac

Problems with the current "preview" deploys generated by Vercel:
- previews are only generated for the "local" repo, i.e. the one in which the PR is submitted. Endpoints generated by the "other" repos are not accessible within the preview.
- nginx routing cannot be checked within the preview
- SEO analysis cannot be undertaken within the preview
- Vercel limits us to 12 concurrent build slots (the most avaialable at our membership level), so builds for deploy to preview are sometimes queued. This problem will certainly worsen as the engineering output grows.

## Considerations

The current state of user-facing side of `goteleport.com` is as follows: 
- routing is handled by nginx and its config files are hosted on `gravitational/web`
- roughly 1000 pages of docs are hosted at `gravitational/teleport` and imported as submodules into `gravitational/next`
- roughly 100 pages of user-facing marketing pages are hosted on `gravitational/next`
- roughly 200 pages of blog articles are hosted on `gravitational/web`
- a few remaining pages are hosted on `gravitational/web` but should be ported to `gravitational/next` by the end of February 2022.

The intention at present is for `gravitational/web` to be deprecated entirely and for the routing functionality currently in `gravitational/web/deploy/nginx.*` to be ported to Vercel and/or `gravitational/next`.

However discussions are now underway concerning the **possible** separation of the three main parts of `goteleport.com`: the main website (hereafter the "marketing site"), the blog, and the docs would each live in separate repos and potentially leverage separate site generation technologies, e.g. Next, Gatsby, or combination with headless CMS.

For SEO purposes, subdomains, e.g. `docs.goteleport.com` will not be used.

## Desired Functionality of the new Staging Environment and Deploy Pipeline

1. ability to preview builds at a single (can be dynamic) url involving a user-defined number of repos, i.e. just the blog, just the marketing site, blog and marketing, all three, or any other combination 
2. ability for multiple users to generate complete (comprising all three repos) preview builds simultaneously (this point mainly to explicitly provide contrast to the singular "staging" environment we currently use)
3. when a push is made to the `seo` branch of the marketing site, a build is triggered for all three repos and the result deployed at the static domain registered with Semrush (our SEO monitoring service) to analyze SEO impact before deploying to production (this is necessary for workflow if possible - see UX section below)
4. relevant validations before any preview occurs (this section to be expanded with list of validations)

### Notes on Functionality

- not all changes require Semrush interaction
- Semrush audits are only valid for builds that are comprised of current version of all three parts (blog, marketing and docs); Semrush needs to be run on as true a mirror of production as possible.
- individual components for the separate repositories may or may not be shared through a common library, but assuming that all repos are independent in this fashion is probably ok. 

## Security 

Unknown at present - but see @wadell's further considerations below

## UX

It is becoming increasingly common for non-technical marketing personnel to make changes to the user-facing website in the form of updates to marketing copy or adding/removing events using GitHub's web GUI (and potentially GitHub Desktop). Currently "preview" deploys are auto-generated by Vercel, but they are only built for pages in the local repository, e.g. previews in `/next` aren't able to see endpoints in `/web`.

A system whereby non-techincal users could trigger a deploy to staging from GitHub's web GUI (if not Desktop) would be ideal.


## Potential Solutions

Vercel _probably_ provides an out-of-the-box solution for some of the above requirements, but the purpose of this RFD is to explore that and other options. 

## Further considerations from @wadells up for discussion (to be incorporated above)

- Will there be a cache/CDN/DDOS protection? What provides that?
- Can we use vercel's routing, or will we stick with an nginx reverse proxy? If nginx, where will it be hosted, and how will we deploy?
- If we split the site up, what versions of the different components will be deployed? E.g. consider a blog post. When its preview is generated, what version of the marketing site and docs will be used in that preview, if any? Will we support a way to preview changes to more than one (or all) component sites at the same time (e.g. a redesign that includes marketing, docs, and blog edits in one go)?
- What are the build/deploy time and determinism consequences of our plan? Are those acceptable to the team?